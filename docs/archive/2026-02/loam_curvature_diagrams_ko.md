# LOAM 곡률 버그 - 시각적 다이어그램

이 문서는 LOAM 곡률 구현 버그 분석을 시각화한 UML 다이어그램들을 포함하고 있습니다.

## 보는 방법

다이어그램들은 PlantUML 형식으로 작성되었습니다. 다음 방법들로 확인할 수 있습니다:

1. **온라인**: PlantUML 코드를 http://www.plantuml.com/plantuml/ 에 복사하여 붙여넣기
2. **VS Code**: "PlantUML" 확장 설치
3. **명령행(CLI)**: `plantuml loam_curvature_uml.puml` 실행

## 다이어그램 개요

### 1. LOAM_Curvature_Comparison
**목적**: 곡률 공식의 병렬 비교  
**포함 내용**: 
- Original LOAM 구현 (정상)
- LIO-SAM 구현 (정상, 최적화됨)
- 현재 구현 (버그 발생)
- 수정된 구현 (정상)

**핵심 인사이트**: 현재 구현은 잘못된 정규화를 사용하여, 거리에 의존해야 할 곡률 값을 거리와 무관하게 만들고 있습니다.

---

### 2. LOAM_Feature_Extraction_Flow
**목적**: 알고리즘 순서도 비교  
**포함 내용**: 각 구현별 단계별 실행 흐름

**핵심 인사이트**: 버그는 곡률 계산 단계에서 발생하며, 이후의 모든 특징점 선택 과정에 영향을 미칩니다.

---

### 3. LOAM_Bug_Impact_Sequence
**목적**: 버그가 나타나는 과정을 보여주는 시퀀스 다이어그램  
**포함 내용**: 동일한 기하학적 특징이 거리에 따라 어떻게 다른 결과를 내는지 시연

**구체적 예시**:
- 가까운 점 (1m): 곡률 = 0.05
- 먼 점 (10m, 동일한 기하 구조): 곡률 = 0.05 (오류 - 25가 되어야 함)

**영향**: 먼 거리의 엣지 누락, 가까운 평면의 오분류 발생.

---

### 4. LOAM_Math_Comparison
**목적**: 수학적 공식 세부 분석  
**포함 내용**: 
- 입력 파라미터
- 계산 단계
- 출력 값 및 단위

**주요 차이점**:
| 속성 | Original LOAM | 현재 구현 (버그) |
|----------|---------------|---------------|
| 공식 | `||Σ X_j - 10·X_i||²` | `||10·X_i - Σ X_j|| / (10·||X_i||)` |
| 단위 | m² | 무차원 (dimensionless) |
| 제곱 여부 | 예 | 아니오 (제곱근) |
| 정규화 여부 | 아니오 | 예 (`||X_i||` 사용) |
| 거리 의존성 | 예 (r²) | 아니오 (정규화로 제거됨) |

---

### 5. LOAM_Class_Diagram
**목적**: 객체 지향 구조 파악  
**포함 내용**: 클래스 계층 구조 및 관계

**클래스 구성**:
- `FeatureExtractor` (추상 베이스 클래스)
- `OriginalLOAM` (레퍼런스 구현)
- `LIO_SAM` (최적화된 변형)
- `CurrentImplementation` (버그 포함)
- `FixedImplementation` (수정 완료)

---

### 6. LOAM_State_Machine
**목적**: 특징점 분류 상태 전이  
**포함 내용**: 포인트가 로드됨 → 곡률 계산됨 → 분류됨으로 이동하는 과정

**상태 비교**:
- **Original LOAM 상태**: 거리 의존적 곡률 → 올바른 분류
- **현재 버그 상태**: 거리 무관 곡률 → 먼 거리 포인트에 대한 잘못된 분류

---

### 7. LOAM_Component_Diagram
**목적**: 시스템 아키텍처 뷰  
**포함 내용**: 입력부터 출력까지의 컴포넌트 간 상호작용

**컴포넌트 구성**:
1. 입력 처리 (Reader → Ring Grouping → Angle Sorting)
2. 곡률 계산 (3가지 변형 제시)
3. 특징점 선택 (Sort → Filter → Output)
4. 출력 (LOAMFeatures)

**데이터 흐름**: 2번 컴포넌트의 버그가 잘못된 곡률 값을 3번과 4번 컴포넌트로 전파합니다.

---

## 빠른 참조: 한 장으로 보는 버그

```
┌─────────────────────────────────────────────────────────────┐
│                           버그 분석                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  정상 (Original LOAM):                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ c = ||Σ X_j - 10·X_i||²                             │   │
│  │                                                      │   │
│  │ • 제곱 노름(Squared norm)                            │   │
│  │ • 정규화 없음                                         │   │
│  │ • 단위: m²                                           │   │
│  │ • 먼 점 → 높은 곡률 (거리²에 비례)                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  오류 (현재 구현):                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ c = ||10·X_i - Σ X_j|| / (10·||X_i||)              │   │
│  │                                                      │   │
│  │ • 단일 노름 (제곱 아님)                                │   │
│  │ • ||X_i||로 정규화됨  ← 버그 발생 지점!                │   │
│  │ • 단위: 무차원 (dimensionless)                        │   │
│  │ • 먼 점 → 동일한 곡률 (거리가 정규화됨)                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  영향:                                                       │
│  • 거리 편향: 먼 거리의 엣지가 인위적으로 낮은 점수를 받음      │
│  • 특징점 오류: 잘못된 엣지/평면 분류                         │
│  • 정합 성능 저하: 최적이 아닌 특징점 대응 관계 형성            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 수치 예시 시각화

```
장면: 두 가지 거리에 있는 벽 모서리(Corner)

┌──────────────────────────────────────────────────────────────┐
│ 가까운 모서리 (1m)            먼 모서리 (10m)                   │
│                                                              │
│     👁 ←─1m─→ │           👁 ←────── 10m ────────→ │       │
│    센서      모서리        센서                모서리        │
│                                                              │
│ 기하 구조: 동일한 90도 각도                                    │
│                                                              │
│ ┌─────────────────────────┬─────────────────────────┐       │
│ │ Original LOAM           │                         │       │
│ ├─────────────────────────┼─────────────────────────┤       │
│ │ c_near  = 0.25 m²      │ c_far  = 25 m²         │       │
│ │ 비율: 1                 │ 비율: 100               │       │
│ │ 결과: ✓ 둘 다 엣지로 검출                            │       │
│ └─────────────────────────┴─────────────────────────┘       │
│                                                              │
│ ┌─────────────────────────┬─────────────────────────┐       │
│ │ 현재 구현 (버그)          │                         │       │
│ ├─────────────────────────┼─────────────────────────┤       │
│ │ c_near  = 0.05         │ c_far  = 0.05           │       │
│ │ 비율: 1                 │ 비율: 1    ← 오류!      │       │
│ │ 결과: ✗ 먼 모서리는 누락될 수 있음                   │       │
│ └─────────────────────────┴─────────────────────────┘       │
└──────────────────────────────────────────────────────────────┘

결론: 버그가 있는 구현은 가까운 특징과 먼 특징을 동일하게 취급하여, 
먼 거리의 엣지가 과소 대표(under-represented)되는 결과를 초래합니다.
```

---

## 수정 요약

**수정할 파일**: `loam_feature.cpp`

**수정할 함수**:
1. `extract_loam_features_ring_based()` (122-135라인)
2. `extract_loam_features_knn()` (230-246라인)

**필요한 변경 사항**:
```cpp
// 수정 전 (버그):
Eigen::Vector3d diff_sum = Eigen::Vector3d::Zero();
for (int j = -5; j <= 5; j++) {
    if (j == 0) continue;
    diff_sum += (X_i - X_j);  // ❌ 오류
}
double c = diff_sum.norm() / (10 * X_i.norm());  // ❌ 오류

// 수정 후 (정상):
Eigen::Vector3d diff_vec = -10.0 * X_i;  // 중심점에 가중치 부여
for (int j = -5; j <= 5; j++) {
    if (j == 0) continue;
    diff_vec += X_j;  // ✓ 정상
}
double c = diff_vec.squaredNorm();  // ✓ 정상
```

---

## 참고 문헌

- **Original LOAM 논문**: Zhang & Singh, RSS 2014  
  [PDF](https://www.ri.cmu.edu/pub_files/2014/7/Ji_LidarMapping_RSS2014_v8.pdf)

- **레퍼런스 구현체**: laboshinl/loam_velodyne  
  [GitHub](https://github.com/laboshinl/loam_velodyne/blob/master/src/lib/BasicScanRegistration.cpp#L291)

- **LIO-SAM 구현체**: TixiaoShan/LIO-SAM  
  [GitHub](https://github.com/TixiaoShan/LIO-SAM/blob/master/src/featureExtraction.cpp#L67)

---

## 관련 문서

- `loam_curvature_bug_analysis.md` - 상세 기술 분석
- `loam_curvature_uml.puml` - 모든 다이어그램의 PlantUML 소스 코드
